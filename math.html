<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom right, #60a5fa, #9333ea);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            transition: background-image 0.5s ease-in-out;
        }
        body.challenge-day-bg {
            background-image: linear-gradient(to bottom right, #facc15, #ef4444);
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 32rem;
            width: 100%;
            position: relative;
        }
        .problem-display {
            font-size: 3.75rem;
            line-height: 1;
            font-weight: 800;
            color: #1e40af;
            margin-bottom: 0.25rem;
            letter-spacing: 0.025em;
            text-align: center;
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
        }
        @media (min-width: 640px) {
            .problem-display {
                font-size: 4.375rem;
            }
        }
        .input-field {
            font-size: 36px;
            line-height: 1;
            width: 100%;
            max-width: 28rem;
            font-weight: 400;
            color: #1e40af;
            margin-left: auto;
            margin-right: auto;
            letter-spacing: 0.05em;
            text-align: center;
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
            border-width: 2px;
            border-color: #60a5fa;
            outline: none;
            transition-property: all;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.75rem;
            padding: 0.25rem;
            margin-bottom: 0rem;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
        }
        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .btn {
            padding-left: 2rem;
            padding-right: 2rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition-property: all;
            transition-duration: 300ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .btn:hover {
            transform: scale(1.05) translateY(-0.25rem);
        }
        .btn-green {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }
        .btn-green:hover {
            background-image: linear-gradient(to right, #22c55e, #15803d);
        }
        .btn-blue {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
        }
        .btn-blue:hover {
            background-image: linear-gradient(to right, #2563eb, #1d4ed8);
        }
        .message-box {
            min-height: 30px;
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.25rem;
        }
        .message-success {
            color: #047857;
        }
        .message-error {
            color: #b91c1c;
        }
        .score-display, .timer-display, .best-time-display {
            position: absolute;
            background-color: #fcd34d;
            color: #b45309;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }
        .score-display {
            top: 1rem;
            right: 1rem;
        }
        .timer-display {
            top: 5rem; /* Position below score */
            right: 1rem;
            background-color: #fef08a; /* Lighter yellow for timer */
            color: #b45309;
        }
        .best-time-display {
            top: 9rem; /* Position below timer */
            right: 1rem;
            background-color: #fef9c3; /* Even lighter yellow for best time */
            color: #b45309;
        }

        /* Keypad Styles */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 28rem;
            margin-top: 1rem;
        }
        .keypad-btn {
            padding: 0; /* Remove padding to let min-width/height control size */
            border-radius: 0.75rem;
            font-size: 1.875rem;
            font-weight: 700;
            background-color: #e5e7eb;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition-property: all;
            transition-duration: 150ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            min-height: 60px;
        }
        .keypad-btn:hover {
            background-color: #d1d5db;
        }
        .keypad-btn:active {
            background-color: #9ca3af;
        }
        .keypad-btn-action {
            background-color: #f87171;
            color: white;
        }
        .keypad-btn-action:hover {
            background-color: #ef4444;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 28rem;
            margin-top: 1rem;
        }
        /* Difficulty Toggle Styles */
        .difficulty-toggle {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            background-color: #e5e7eb;
            border-radius: 9999px;
            padding: 0.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            /* Ensure it can accommodate more options */
            flex-wrap: wrap; 
            gap: 0.25rem; /* Small gap between options if wrapped */
            max-width: calc(100% - 2rem); /* Prevent overflow on very small screens */
        }
        .difficulty-option {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #4b5563; /* text-gray-600 */
        }
        .difficulty-option.selected {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        }
        .difficulty-option:not(.selected):hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        /* Challenge Day Sticker */
        .challenge-sticker {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%) rotate(-5deg);
            background-color: #facc15; /* yellow-400 */
            color: #b45309; /* amber-700 */
            padding: 0.5rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 800;
            font-size: 1.5rem;
            text-transform: uppercase;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 20;
            animation: bounce 0.8s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateX(-50%) rotate(-5deg) translateY(0); }
            to { transform: translateX(-50%) rotate(-5deg) translateY(-5px); }
        }
        .turn-off-challenge-btn {
            background-image: linear-gradient(to right, #ef4444, #dc2626);
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .turn-off-challenge-btn:hover {
            background-image: linear-gradient(to right, #dc2626, #b91c1c);
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div class="difficulty-toggle" id="difficulty-toggle">
        <div class="difficulty-option selected" data-difficulty="easy">Easy</div>
        <div class="difficulty-option" data-difficulty="medium">Medium</div>
        <div class="difficulty-option" data-difficulty="hard">Hard</div>
        <div class="difficulty-option" data-difficulty="timeTrial">Time Trial</div>
    </div>

    <div class="score-display" id="score-display">Score: 0</div>
    <div class="timer-display hidden" id="timer-display">Time: 0.0s</div>
    <div class="best-time-display hidden" id="best-time-display">Best: N/A</div>
    <div id="challenge-sticker" class="challenge-sticker hidden">Challenge Day!</div>

    <div class="container">
        <div id="problem-display" class="problem-display"></div>
        <input type="number" class="input-field" id="answer-input" placeholder="Your Answer" readonly>
        <div id="message-box" class="message-box">&nbsp;</div>
        <div class="keypad-grid" id="keypad">
            <button class="keypad-btn" data-value="1">1</button>
            <button class="keypad-btn" data-value="2">2</button>
            <button class="keypad-btn" data-value="3">3</button>
            <button class="keypad-btn" data-value="4">4</button>
            <button class="keypad-btn" data-value="5">5</button>
            <button class="keypad-btn" data-value="6">6</button>
            <button class="keypad-btn" data-value="7">7</button>
            <button class="keypad-btn" data-value="8">8</button>
            <button class="keypad-btn" data-value="9">9</button>
            <button class="keypad-btn keypad-btn-action" data-value="clear">Clear</button>
            <button class="keypad-btn" data-value="0">0</button>
            <button class="keypad-btn keypad-btn-action" data-value="backspace">⌫</button>
        </div>
        <div class="button-grid">
            <button id="check-btn" class="btn btn-green">Check Answer</button>
            <button id="new-problem-btn" class="btn btn-blue">Show Answer</button>
        </div>
        <button id="turn-off-challenge-btn" class="turn-off-challenge-btn hidden">Turn Off Challenge Day</button>
    </div>

    <script>
        // DOM Elements
        const problemDisplay = document.getElementById('problem-display');
        const answerInput = document.getElementById('answer-input');
        const checkBtn = document.getElementById('check-btn');
        const newProblemBtn = document.getElementById('new-problem-btn');
        const messageBox = document.getElementById('message-box');
        const scoreDisplay = document.getElementById('score-display');
        const keypad = document.getElementById('keypad');
        const difficultyToggle = document.getElementById('difficulty-toggle');
        const challengeSticker = document.getElementById('challenge-sticker');
        const body = document.body;
        const timerDisplay = document.getElementById('timer-display');
        const bestTimeDisplay = document.getElementById('best-time-display');
        const turnOffChallengeBtn = document.getElementById('turn-off-challenge-btn'); // New

        // Game State Variables
        let currentProblem = {}; // Stores {num1, num2, operator, answer}
        let score = 0;
        let difficulty = 'easy'; // Default difficulty

        // Challenge Day Variables
        const CHALLENGE_INTERVAL_DAYS = 3; // Every 3 days, it's a challenge day
        let isChallengeDay = false;
        let originalScore = 0; // To store score before challenge day
        let challengeHighScore = 0; // High score achieved on the current challenge day

        // Time Trial Variables
        let timerInterval;
        let startTime;
        let bestTime = Infinity; // Stores the shortest time, initialized to infinity
        let questionsAnsweredTimeTrial = 0;
        const TOTAL_TIME_TRIAL_QUESTIONS = 5; // Number of questions for Time Trial

        // Difficulty Settings
        const difficultySettings = {
            easy: { min: 0, max: 10, operations: ['+', '-'], type: 'normal' },
            medium: { min: 0, max: 10, operations: ['+', '-', 'x'], type: 'normal' },
            hard: { min: 0, max: 10, operations: ['+', '-', 'x', '/'], type: 'normal' },
            timeTrial: { min: 0, max: 9, operations: ['+'], type: 'timed' }
        };

        // --- Helper Functions ---
        /**
         * Saves the current game state to localStorage, including Time Trial best time.
         */
        function saveGameState() {
            localStorage.setItem('mathChallengeScore', score);
            localStorage.setItem('mathChallengeDifficulty', difficulty);
            // Only update lastChallengeDate if it's currently a challenge day
            if (isChallengeDay) localStorage.setItem('lastChallengeDate', new Date().toDateString()); 
            localStorage.setItem('isChallengeDay', isChallengeDay);
            localStorage.setItem('originalScore', originalScore);
            localStorage.setItem('challengeHighScore', challengeHighScore);
            localStorage.setItem('bestTime', bestTime === Infinity ? 'Infinity' : bestTime.toFixed(1)); // Save best time
        }

        /**
         * Loads the game state from localStorage, including Time Trial best time.
         */
        function loadGameState() {
            const savedScore = localStorage.getItem('mathChallengeScore');
            const savedDifficulty = localStorage.getItem('mathChallengeDifficulty');
            const lastChallengeDateStr = localStorage.getItem('lastChallengeDate');
            const savedIsChallengeDay = localStorage.getItem('isChallengeDay');
            const savedOriginalScore = localStorage.getItem('originalScore');
            const savedChallengeHighScore = localStorage.getItem('challengeHighScore');
            const savedBestTime = localStorage.getItem('bestTime');

            if (savedScore !== null) {
                score = parseInt(savedScore);
            }
            if (savedDifficulty !== null) {
                difficulty = savedDifficulty;
            }
            if (savedIsChallengeDay === 'true') {
                isChallengeDay = true;
            }
            if (savedOriginalScore !== null) {
                originalScore = parseInt(savedOriginalScore);
            }
            if (savedChallengeHighScore !== null) {
                challengeHighScore = parseInt(savedChallengeHighScore);
            }
            if (savedBestTime !== null && savedBestTime !== 'Infinity') {
                bestTime = parseFloat(savedBestTime);
            } else if (savedBestTime === 'Infinity') {
                bestTime = Infinity;
            }

            checkChallengeDay(lastChallengeDateStr); // Check challenge day status on load
            updateDisplays();
            updateDifficultyToggle();
            updateChallengeButtonVisibility(); // New: update button visibility
        }

        /**
         * Checks if it's a challenge day and updates game state accordingly.
         * @param {string} lastChallengeDateStr The string representation of the last challenge date from localStorage.
         */
        function checkChallengeDay(lastChallengeDateStr) {
            const today = new Date();
            const todayDateStr = today.toDateString();
            let lastChallengeDate = lastChallengeDateStr ? new Date(lastChallengeDateStr) : null;

            // If it's already a challenge day and still the same day, keep styling
            if (isChallengeDay && todayDateStr === lastChallengeDateStr) {
                applyChallengeDayStyling();
                updateChallengeButtonVisibility();
                return;
            } 
            
            // If it was a challenge day but today is a new day, reset challenge state
            if (isChallengeDay && todayDateStr !== lastChallengeDateStr) {
                score = originalScore; // Restore original score
                isChallengeDay = false;
                originalScore = 0;
                challengeHighScore = 0; // Reset challenge high score for the new non-challenge day
                removeChallengeDayStyling();
                saveGameState(); // Save the reset state
            }

            let daysSinceLastChallenge = 0;
            if (lastChallengeDate && !isNaN(lastChallengeDate.getTime())) {
                const diffTime = Math.abs(today.getTime() - lastChallengeDate.getTime());
                daysSinceLastChallenge = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            } else {
                daysSinceLastChallenge = CHALLENGE_INTERVAL_DAYS; // Trigger challenge on first run if no valid date
            }

            if (daysSinceLastChallenge >= CHALLENGE_INTERVAL_DAYS) {
                isChallengeDay = true;
                originalScore = score; // Store current score as original
                score = 0; // Reset score for challenge day
                challengeHighScore = 0; // Start challenge high score at 0
                applyChallengeDayStyling();
                showMessage("It's CHALLENGE DAY! Score for high score!", "success", 3);
            } else {
                isChallengeDay = false; // Explicitly set to false if not challenge day
                removeChallengeDayStyling();
            }
            saveGameState(); // Save the new challenge status
            updateChallengeButtonVisibility(); // Update button visibility based on the new status
        }

        /**
         * Applies special styling for challenge day.
         */
        function applyChallengeDayStyling() {
            body.classList.add('challenge-day-bg');
            challengeSticker.classList.remove('hidden');
        }

        /**
         * Removes special styling after challenge day.
         */
        function removeChallengeDayStyling() {
            body.classList.remove('challenge-day-bg');
            challengeSticker.classList.add('hidden');
        }

        /**
         * Generates a random integer within a specified range.
         * @param {number} min The minimum value (inclusive).
         * @param {number} max The maximum value (inclusive).
         * @returns {number} A random integer.
         */
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Displays a message to the user.
         * @param {string} message The message to display.
         * @param {string} type 'success' or 'error' to determine styling.
         * @param {number} seconds The duration in seconds to display the message.
         */
        function showMessage(message, type, seconds) {
            messageBox.textContent = message;
            messageBox.className = 'message-box ' + (type === 'success' ? 'message-success' : 'message-error');
            setTimeout(() => {
                messageBox.innerHTML = '&nbsp;';
                messageBox.className = 'message-box';
            }, seconds * 1000);
        }

        /**
         * Updates all displays (score, timer, best time).
         */
        function updateDisplays() {
            let displayScore = `Score: ${score}`;
            if (isChallengeDay) {
                displayScore += ` (High Score: ${challengeHighScore})`;
            }
            scoreDisplay.textContent = displayScore;

            if (difficulty === 'timeTrial') {
                scoreDisplay.classList.add('hidden');
                timerDisplay.classList.remove('hidden');
                bestTimeDisplay.classList.remove('hidden');
                bestTimeDisplay.textContent = `Best: ${bestTime === Infinity ? '-' : bestTime.toFixed(1) + 's'}`;
            } else {
                scoreDisplay.classList.remove('hidden');
                timerDisplay.classList.add('hidden');
                bestTimeDisplay.classList.add('hidden');
            }
        }

        /**
         * Updates the visual state of the difficulty toggle.
         */
        function updateDifficultyToggle() {
            document.querySelectorAll('.difficulty-option').forEach(option => {
                if (option.dataset.difficulty === difficulty) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        /**
         * Updates the visibility of the "Turn Off Challenge Day" button.
         */
        function updateChallengeButtonVisibility() {
            if (isChallengeDay) {
                turnOffChallengeBtn.classList.remove('hidden');
            } else {
                turnOffChallengeBtn.classList.add('hidden');
            }
        }

        // --- Timer Functions ---
        function startTimer() {
            stopTimer(); // Clear any existing timer first
            startTime = new Date().getTime();
            timerDisplay.textContent = `Time: 0.0s`; // Reset display immediately
            timerInterval = setInterval(() => {
                const elapsedTime = (new Date().getTime() - startTime) / 1000;
                timerDisplay.textContent = `Time: ${elapsedTime.toFixed(1)}s`;
            }, 100);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // --- Game Logic ---
        /**
         * Generates a new math problem based on the current difficulty.
         */
        function generateProblem() {
            const config = difficultySettings[difficulty];
            let num1, num2, operator, answer;

            if (config.type === 'timed') {
                num1 = getRandomInt(config.min, config.max);
                num2 = getRandomInt(config.min, config.max);
                operator = '+';
                answer = num1 + num2;
            } else {
                operator = config.operations[(Math.random() * config.operations.length) | 0];

                switch (operator) {
                    case '+':
                        num1 = getRandomInt(config.min, config.max);
                        num2 = getRandomInt(config.min, config.max);
                        answer = num1 + num2;
                        break;
                    case '-':
                        num2 = getRandomInt(config.min, config.max);
                        answer = getRandomInt(config.min, config.max);
                        num1 = num2 + answer;
                        break;
                    case 'x':
                        num1 = getRandomInt(config.min, config.max);
                        num2 = getRandomInt(config.min, config.max);
                        answer = num1 * num2;
                        break;
                    case '/':
                        let divisor, result;
                        do {
                            divisor = getRandomInt(1, config.max);
                            result = getRandomInt(config.min, config.max);
                            num1 = divisor * result;
                        } while (num1 > config.max || num1 < config.min);
                        num2 = divisor;
                        answer = result;
                        break;
                }
            }

            currentProblem = { num1, num2, operator, answer };
            problemDisplay.textContent = `${num1} ${operator} ${num2} = ?`;
            answerInput.value = '';
            showMessage('', '', 0); // Clear any previous messages immediately
        }

        /**
         * Checks the user's answer against the correct solution.
         */
        function checkAnswer() {
            const userAnswer = parseInt(answerInput.value);

            if (isNaN(userAnswer)) {
                showMessage("Please enter a number!", "error", 2);
                return;
            }

            const isCorrect = (userAnswer === currentProblem.answer);

            if (difficulty === 'timeTrial') {
                if (isCorrect) {
                    questionsAnsweredTimeTrial++;
                    showMessage(`Correct! ${questionsAnsweredTimeTrial}/${TOTAL_TIME_TRIAL_QUESTIONS}`, "success", 1);
                    if (questionsAnsweredTimeTrial === TOTAL_TIME_TRIAL_QUESTIONS) {
                        stopTimer();
                        const finalTime = (new Date().getTime() - startTime) / 1000;
                        
                        if (finalTime < bestTime) {
                            bestTime = finalTime;
                            showMessage(`New Best Time! ${bestTime.toFixed(1)}s`, "success", 5);
                        } else {
                            showMessage(`Time Trial Complete! Your Time: ${finalTime.toFixed(1)}s`, "success", 5);
                        }
                        saveGameState();
                        updateDisplays();
                        
                        setTimeout(startGame, 3000); 
                    } else {
                        generateProblem(); 
                    }
                } else {
                    showMessage(`Oops! Try again. The answer was ${currentProblem.answer}.`, "error", 2);
                }
            } else {
                if (isCorrect) {
                    showMessage("Correct! 🎉", "success", 2);
                    score++;
                    if (isChallengeDay) {
                        challengeHighScore = Math.max(challengeHighScore, score);
                    }
                    updateDisplays();
                    saveGameState();
                    setTimeout(generateProblem, 1000);
                } else {
                    showMessage(`Oops! Try again.`, "error", 2); 
                }
            }
        }

        /**
         * Reveals the correct answer and generates a new problem.
         * Behavior adjusted for Time Trial.
         */
        function showCorrectAnswerAndNewProblem() {
            if (difficulty === 'timeTrial') {
                showMessage(`The answer was ${currentProblem.answer}. Skipping...`, "error", 2);
                questionsAnsweredTimeTrial++;
                if (questionsAnsweredTimeTrial === TOTAL_TIME_TRIAL_QUESTIONS) {
                    stopTimer();
                    const finalTime = (new Date().getTime() - startTime) / 1000;
                    showMessage(`Time Trial Complete! Your Time: ${finalTime.toFixed(1)}s`, "success", 5);
                    saveGameState();
                    updateDisplays();
                    setTimeout(startGame, 3000);
                } else {
                    setTimeout(generateProblem, 1500); 
                }
            } else {
                const userAnswer = parseInt(answerInput.value);
                const isCorrect = (userAnswer === currentProblem.answer);

                if (isCorrect) {
                    showMessage("Correct! 🎉", "success", 2);
                    score++;
                    if (isChallengeDay) {
                        challengeHighScore = Math.max(challengeHighScore, score);
                    }
                    updateDisplays();
                    saveGameState();
                    setTimeout(generateProblem, 1000);
                } else {
                    showMessage(`The correct answer was ${currentProblem.answer}.`, "error", 5);
                    if (!isNaN(userAnswer) && !isChallengeDay) {
                        score = Math.max(0, score - 1); // Deduct point if incorrect and not on challenge day
                    }
                    updateDisplays();
                    saveGameState();
                    setTimeout(generateProblem, 1000);
                }
            }
        }

        /**
         * Initializes or restarts the game based on current difficulty.
         */
        function startGame() {
            answerInput.value = '';
            showMessage('', '', 0);

            if (difficulty === 'timeTrial') {
                questionsAnsweredTimeTrial = 0;
                startTimer();
            } else {
                stopTimer();
            }
            updateDisplays();
            generateProblem();
        }

        /**
         * Turns off Challenge Day mode.
         */
        function turnOffChallengeDay() {
            if (isChallengeDay) {
                isChallengeDay = false;
                score = originalScore; // Restore score to what it was before challenge day
                originalScore = 0; // Reset original score
                challengeHighScore = 0; // Reset challenge high score
                localStorage.removeItem('lastChallengeDate'); // Clear the last challenge date
                removeChallengeDayStyling();
                saveGameState();
                updateDisplays();
                updateChallengeButtonVisibility();
                showMessage("Challenge Day turned off. Enjoy your regular practice!", "success", 3);
                startGame(); // Start a new game in normal mode
            }
        }


        // --- Keypad Logic ---
        keypad.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('keypad-btn')) {
                const value = target.dataset.value;

                if (value === 'clear') {
                    answerInput.value = '';
                } else if (value === 'backspace') {
                    answerInput.value = answerInput.value.slice(0, -1);
                } else {
                    if (answerInput.value.length < 10) { // Limit input length
                        answerInput.value += value;
                    }
                }
            }
        });

        // --- Difficulty Toggle Logic ---
        difficultyToggle.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('difficulty-option')) {
                const newDifficulty = target.dataset.difficulty;
                if (difficulty !== newDifficulty) {
                    difficulty = newDifficulty;
                    updateDifficultyToggle();
                    saveGameState();
                    startGame();
                }
            }
        });

        // --- Event Listeners ---
        checkBtn.addEventListener('click', checkAnswer);
        newProblemBtn.addEventListener('click', showCorrectAnswerAndNewProblem);
        turnOffChallengeBtn.addEventListener('click', turnOffChallengeDay); // New event listener

        // Allow 'Enter' key to submit answer
        answerInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                checkAnswer();
            }
        });

        // Initial game setup
        window.onload = function() {
            loadGameState();
            startGame();
        };
    </script>
</body>
</html>
